@using Unshackled.Kitchen.Core.Models

@inherits RecipeListBuilderBase

<MudText Typo="Typo.body1" Class="my-3">Review product quantities for each ingredient</MudText>
<ListView TItem="AddToShoppingListModel" Items="@ActiveItems" IsLoading="@IsLoading">
	<ItemRenderer>
		<MudGrid Spacing="2" Class="@GetClass(context.Item)">
			<MudItem xs="12">
				<div class="d-flex flex-row gap-4">
					<div class="d-flex flex-row gap-x-2 align-end flex-wrap flex-grow-1">
						<MudText Typo="Typo.body1">@context.Item.ProductTitle.ToUpper()</MudText>
						<MudText Typo="Typo.body2">for @context.Item.IngredientTitle</MudText>
					</div>
					<div>
						<MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@(() => HandleToggleSkipped(context.Item))" />
					</div>
				</div>
			</MudItem>
			@if (context.Item.IsAutoGenerated)
			{
				<MudItem xs="12">
					<MudAlert Severity="Severity.Info" NoIcon="true" Elevation="0" Dense="true">
						<MudText Typo="Typo.caption">
							No product substituion was found. A new product and product substitution will be created when added to the shopping list.
						</MudText>
					</MudAlert>
				</MudItem>
			}
			@if (context.Item.IsUnitMismatch) 
			{
				<MudItem xs="12">
					<MudAlert Severity="Severity.Error" NoIcon="true" Elevation="0" Dense="true">
						<MudText Typo="Typo.caption">
							Recipe ingredient unit and product serving size unit are incompatible. The required quantity could not be calculated.
						</MudText>
					</MudAlert>
				</MudItem>
			}
			<MudItem xs="12">
				<MudGrid Spacing="1">
					@if (context.Item.RecipeAmounts.Any())
					{
						<MudItem xs="12">
							<div class="d-flex flex-column gap-1 mb-2">
								<MudText Typo="Typo.body2" Color="Color.Tertiary">Recipe Requirements: </MudText>
								@foreach (var amt in context.Item.RecipeAmounts)
								{
									<div class="d-flex flex-row gap-2 align-center">
										<MudText Typo="Typo.body2">
											<IngredientText Amount="@amt.IngredientAmount" AmountLabel="@amt.IngredientAmountUnitLabel" Title="@amt.RecipeTitle" />
										</MudText>
										@if (amt.IsUnitMismatch)
										{
											<MudText Typo="Typo.caption" Color="Color.Error">
												@amt.IngredientAmountUnitLabel &rarr; @amt.ServingSizeUnitLabel (@amt.IngredientAmountUnitType.Label() &rarr; @amt.ServingSizeUnitType.Label())
											</MudText>
										}
									</div>
								}
							</div>
						</MudItem>
					}
					<MudItem xs="6" sm="4">
						<CaptionedProperty Title="Quantity To Add">
							<div class="d-flex gap-4 align-center flex-row">
								<MudIconButton Icon="@Icons.Material.Filled.RemoveCircleOutline" Color="Color.Secondary" Size="Size.Small" OnClick="@(() => HandleCounterSubtractClicked(context.Item))" />
								<MudText>@context.Item.QuantityToAdd</MudText>
								<MudIconButton Icon="@Icons.Material.Filled.AddCircleOutline" Color="Color.Secondary" Size="Size.Small" OnClick="@(() => HandleCounterAddClicked(context.Item))" />
							</div>
						</CaptionedProperty>
					</MudItem>
					<MudItem xs="6" sm="4">
						<CaptionedProperty Title="Quantity In List">
							<MudText>@context.Item.QuantityInList</MudText>
						</CaptionedProperty>
					</MudItem>
					<MudItem xs="6" sm="4">
						<CaptionedProperty Title="Total After Add">
							<MudText>@context.Item.TotalQuantity</MudText>
						</CaptionedProperty>
					</MudItem>
				</MudGrid>
			</MudItem>
		</MudGrid>
	</ItemRenderer>
	<EmptyListRenderer>
		<MudText Align="Align.Center" Class="mt-4">Nothing to add.</MudText>
	</EmptyListRenderer>
</ListView>

@if (SkippedItems.Count > 0)
{
	<div class="d-flex flex-row gap-4 align-center mt-2">
		<MudText Typo="Typo.body1" Class="flex-grow-1">@SkippedItems.Count.CountLabel("SKIPPED PRODUCT", "SKIPPED PRODUCTS")</MudText>
		<div>
			<MudIconButton Icon="@(IsCollapsed ? Icons.Material.Filled.ArrowDropDown : Icons.Material.Filled.ArrowDropUp)" Size="Size.Small"
						   title="@(IsCollapsed ? "Collapse" : "Expand")" OnClick="@(() => IsCollapsed = !IsCollapsed)" />
		</div>
	</div>
	<MudDivider DividerType="DividerType.FullWidth" Class="@(IsCollapsed ? "d-block my-2" : "d-none" )" />
	<div class="@(IsCollapsed ? "d-none" : "d-block mb-6")">
		<ListView TItem="AddToShoppingListModel" Items="@SkippedItems" IsLoading="@IsLoading">
			<ItemRenderer>
				<div class="d-flex flex-row gap-4">
					<div>
						<MudIconButton Icon="@Icons.Material.Filled.AddCircle" Size="Size.Small" OnClick="@(() => HandleToggleSkipped(context.Item))" />
					</div>
					<div class="d-flex flex-row gap-x-2 align-end flex-wrap flex-grow-1">
						<MudText Typo="Typo.body1">@context.Item.ProductTitle.ToUpper()</MudText>
						<MudText Typo="Typo.body2">for @context.Item.IngredientTitle</MudText>
					</div>
				</div>
			</ItemRenderer>
		</ListView>
	</div>
}

@if (ActionToolbar != null)
{
	<MudToolBar Gutters="false" Class="my-6">
		@ActionToolbar
	</MudToolBar>
}