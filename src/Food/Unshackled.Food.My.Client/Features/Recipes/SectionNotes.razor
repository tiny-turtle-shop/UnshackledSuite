@inherits SectionNotesBase

@if(IsEditMode || Notes.Any())
{
	<SectionComponent IsEditMode="@IsEditMode" IsEditing="@IsEditing" Class="mb-6">
		<SectionHeader Title="Notes" Typo="Typo.h5" IsEditMode="@IsEditMode" IsEditing="@IsEditing" DisableControls="@DisableControls"
					   OnCancelClicked="@(() => HandleCancelEditClicked())" OnSaveClicked="HandleUpdateClicked">
			<EditModeToolbar>
				<MudIconButton Icon="@Icons.Material.Filled.Edit" Disabled="@DisableSectionControls" OnClick="@(() => HandleEditClicked())" />
			</EditModeToolbar>
		</SectionHeader>

		@if (!IsEditing)
		{
			<ListView Items="@Notes">
				<ItemRenderer>
					<div class="d-flex flex-row gap-4 align-start">
						<div class="d-flex flex-row gap-2 justify-space-between">
							<MudText>@(context.Item.SortOrder + 1)</MudText>
							<MudDivider Vertical="true" FlexItem="true" />
						</div>
						<div class="flex-grow-1">
							<MudText>@((MarkupString)context.Item.Note.ReplaceLineBreaks("<br />"))</MudText>
						</div>
					</div>
				</ItemRenderer>
				<EmptyListRenderer>
					<MudDivider DividerType="DividerType.FullWidth" Class="my-2" />
					<MudAlert Severity="Severity.Normal" Icon="@Icons.Material.Filled.Info">You have not added any notes.</MudAlert>
					<MudDivider DividerType="DividerType.FullWidth" Class="my-2" />
				</EmptyListRenderer>
			</ListView>
		}
		else
		{
			<SortableListView TItem="FormNoteModel" Items="@FormNotes" SortOrderChanged="@HandleSortChanged" IsSortingChanged="@HandleIsSorting" 
				ToolbarPosition="ToolbarPositions.Top" ToolbarAlignment="HorizontalAlignment.Left" DisableSort="@(IsAdding || DisableControls)">
				<ItemRenderer>
					@if (!context.Item.IsEditing)
					{
						<MudGrid Spacing="2" Class="align-stretch">
							<MudItem xs="1" Class="d-flex flex-row gap-2 justify-space-between">
								<MudText>@(context.Item.SortOrder + 1)</MudText>
								<MudDivider Vertical="true" FlexItem="true" />
							</MudItem>
							<MudItem xs="11" sm="10">
								<MudText>@((MarkupString)context.Item.Note.ReplaceLineBreaks("<br />"))</MudText>
							</MudItem>
							<MudItem xs="12" sm="1" Class="d-flex flex-row gap-1 align-start">
								<MudSpacer />
								<MudIconButton Icon="@Icons.Material.Filled.Edit" title="Edit" Disabled="@DisableControls" OnClick="@(() => HandleEditItemClicked(context.Item))" />
								<MudIconButton Icon="@Icons.Material.Filled.Delete" title="Remove" Disabled="@DisableControls" OnClick="@(() => HandleDeleteClicked(context.Item))" />
							</MudItem>
						</MudGrid>
					}
					else
					{
						<FormNote Model="@context.Item" DisableFormControls="@DisableControls" OnFormSubmitted="@HandleEditFormSubmitted" 
								  OnCanceled="@(() => HandleCancelEditItemClicked(context.Item))" />
					}
				</ItemRenderer>
				<ListTools>
					<MudButton Variant="Variant.Text" Color="Color.Default" StartIcon="@Icons.Material.Filled.AddCircle" Disabled="@(DisableControls || IsAdding)"
								OnClick="@(() => HandleAddClicked())">Add</MudButton>
				</ListTools>
				<DraggableItemRenderer>
					<MudPaper Elevation="2" Class="pa-4 my-4">
						<MudGrid Spacing="2" Class="align-stretch">
							<MudItem xs="1">
								<MudIcon Icon="@Icons.Material.Filled.DragHandle" />
							</MudItem>
							<MudItem xs="11">
								<MudText>@context.Note.ToShortString(50, "...")</MudText>
							</MudItem>
						</MudGrid>
					</MudPaper>
				</DraggableItemRenderer>
			</SortableListView>

			@if (IsAdding)
			{
				<FormNote Model="@AddFormModel" DisableFormControls="@DisableControls" OnFormSubmitted="@HandleAddFormSubmitted" OnCanceled="@HandleCancelAddClicked" />
			}
		}
	</SectionComponent>
}